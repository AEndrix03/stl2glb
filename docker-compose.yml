version: "3.8"

volumes:
  vcpkg_cache:
    driver: local
    driver_opts:
      type: none
      device: /home/vcpkg
      o: bind

networks:
  stl2glb-network:
    driver: bridge

services:
  builder:
    image: ubuntu:22.04
    container_name: stl2glb_builder
    volumes:
      - ./:/project
      - vcpkg_cache:/project/external/vcpkg
    working_dir: /project
    command: >
      bash -c "
      apt-get update &&
      apt-get install -y build-essential cmake git curl unzip ninja-build &&
      cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=/project/external/vcpkg/scripts/buildsystems/vcpkg.cmake &&
      cmake --build build --config Release
      "
    networks:
      - stl2glb-network

  app:
    image: ubuntu:22.04
    # Configurazione DNS migliorata
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1  # Aggiunti piÃ¹ server DNS per redundancy
    container_name: stl2glb_app
    depends_on:
      - builder
      - init-minio
    volumes:
      - ./:/project
    working_dir: /project
    command: >
      bash -c "
      apt-get update &&
      apt-get install -y iputils-ping curl wget netcat-openbsd telnet &&
      echo 'Testing connectivity to MinIO...' &&
      ping -c 4 minio.aredegalli.it &&
      curl -v http://minio.aredegalli.it:7800 &&
      echo 'Starting application...' &&
      ./build/stl2glb_exec
      "
    ports:
      - "9002:8080"
    restart: unless-stopped
    env_file:
      - .env
    # Extra hosts per forzare la risoluzione dell'hostname
    extra_hosts:
      - "minio:217.160.248.228"
      - "minio.aredegalli.it:217.160.248.228"
    # Controlli sulla salute per verificare che l'app stia funzionando
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - stl2glb-network