version: "3.8"

services:
  builder:
    image: ubuntu:22.04
    container_name: stl2glb_builder
    volumes:
      - ./:/project
      - vcpkg_cache:/root/vcpkg
    working_dir: /project
    command: >
      bash -c "
      apt-get update &&
      apt-get install -y build-essential cmake git curl unzip &&
      cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=/root/vcpkg/scripts/buildsystems/vcpkg.cmake &&
      cmake --build build --config Release
      "

  app:
    image: ubuntu:22.04
    container_name: stl2glb_app
    depends_on:
      - builder
    volumes:
      - ./:/project
    working_dir: /project
    command: ./build/stl2glb_exec
    environment:
      - .env
    ports:
      - "9002:9002"
    restart: unless-stopped

volumes:
  vcpkg_cache:
    driver: local
    driver_opts:
      type: none
      device: /home/vcpkg
      o: bind
