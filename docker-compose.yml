version: "3.9"

networks:
  stl2glb-net:
    driver: bridge

services:
  # Servizio di build che usa VCPKG dall'host
  builder:
    image: alpine:3.19
    container_name: stl2glb_builder
    volumes:
      - ./:/src:ro
      - /home/vcpkg:/vcpkg:ro
      - build_output:/output
    working_dir: /src
    command: |
      /bin/sh -c '
      set -e
      echo "üîß Installing build dependencies..."
      apk add --no-cache \
        build-base \
        cmake \
        ninja \
        linux-headers \
        openssl-dev \
        pkgconf
      
      echo "üìÅ Creating clean build directory..."
      rm -rf /build
      mkdir -p /build
      cd /build
      
      echo "üìã Copying source files..."
      cp -r /src/* /build/
      rm -rf /build/build /build/cmake-build-* /build/CMakeCache.txt
      
      echo "üî® Fixing STLParser.cpp if needed..."
      if [ -f "src/STLParser.cpp" ]; then
        grep -q "#include <cmath>" src/STLParser.cpp || \
        sed -i "/#include <atomic>/a #include <cmath>" src/STLParser.cpp
      fi
      
      echo "üîç Verifying VCPKG packages..."
      echo "nlohmann-json files:"
      ls -la /vcpkg/installed/x64-linux/share/nlohmann_json/
      echo ""
      echo "httplib files:"
      ls -la /vcpkg/installed/x64-linux/share/cpp-httplib/ || ls -la /vcpkg/installed/x64-linux/include/ | grep httplib
      
      echo "üèóÔ∏è Building with VCPKG..."
      export VCPKG_ROOT=/vcpkg
      export VCPKG_TARGET_TRIPLET=x64-linux
      
      cmake -B build -S . \
        -DCMAKE_BUILD_TYPE=MinSizeRel \
        -DCMAKE_TOOLCHAIN_FILE=/vcpkg/scripts/buildsystems/vcpkg.cmake \
        -DVCPKG_TARGET_TRIPLET=x64-linux \
        -DVCPKG_INSTALLED_DIR=/vcpkg/installed \
        -DVCPKG_MANIFEST_MODE=OFF \
        -DCMAKE_PREFIX_PATH="/vcpkg/installed/x64-linux;/vcpkg/installed/x64-linux/share" \
        -Dnlohmann_json_DIR=/vcpkg/installed/x64-linux/share/nlohmann_json \
        -GNinja
      
      echo "üî® Building project..."
      cmake --build build --config MinSizeRel --parallel
      
      echo "‚úÇÔ∏è Stripping executable..."
      strip build/stl2glb
      
      echo "üì¶ Copying to output..."
      cp build/stl2glb /output/
      ls -la /output/
      
      echo "‚úÖ Build completed!"
      '
    networks:
      - stl2glb-net

  # Servizio app che usa l'eseguibile buildato
  app:
    image: alpine:3.19
    container_name: stl2glb_app
    restart: always
    depends_on:
      builder:
        condition: service_completed_successfully
    volumes:
      - build_output:/app:ro
    entrypoint: ["/bin/sh", "-c"]
    command: |
      "apk add --no-cache libstdc++ libgcc openssl ca-certificates wget && \
       adduser -D -u 1000 -g 1000 appuser 2>/dev/null || true && \
       exec su appuser -c '/app/stl2glb'"

    ports:
      - "9002:8080"
    env_file:
      - .env
    environment:
      - MALLOC_ARENA_MAX=1
      - GOMAXPROCS=1
    dns:
      - 1.1.1.1
      - 8.8.8.8
    extra_hosts:
      - "minio:217.160.248.228"
      - "minio.aredegalli.it:217.160.248.228"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
          pids: 100
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        compress: "true"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:size=50M,noexec,nosuid,nodev
    networks:
      - stl2glb-net

volumes:
  build_output:
    driver: local