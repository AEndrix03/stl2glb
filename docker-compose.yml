version: "3.9"

networks:
  stl2glb-net:
    driver: bridge

services:
  builder:
    image: ubuntu:22.04
    container_name: stl2glb_builder
    volumes:
      - ./:/src:ro
      - /home/vcpkg:/vcpkg:ro
      - build_output:/build_output        # <- qui il builder copia “stl2glb” in /build_output/
    working_dir: /src
    command: >
      bash -c "
        mkdir -p /build &&
        cmake -B /build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DVCPKG_INSTALLED_DIR=/vcpkg/installed &&
        cmake --build /build --config Release --parallel &&
        strip /build/stl2glb &&
        cp /build/stl2glb /build_output/ &&
        chmod +x /build_output/stl2glb
      "
    networks:
      - stl2glb-net

  app:
    build:
      context: .
      dockerfile: Dockerfile       # il Dockerfile di solo runtime mostrato sopra
    image: stl2glb:runtime
    container_name: stl2glb_app
    depends_on:
      builder:
        condition: service_completed_successfully
    volumes:
      - build_output:/build_output    # <- monta il volume dove builder ha scritto il binario
    ports:
      - "9002:8080"
    env_file:
      - .env
    environment:
      - MALLOC_ARENA_MAX=1
      - GOMAXPROCS=1
    dns:
      - 1.1.1.1
      - 8.8.8.8
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    tmpfs:
      - /tmp:size=50M,noexec,nosuid,nodev
    networks:
      - stl2glb-net

volumes:
  build_output:
    driver: local
