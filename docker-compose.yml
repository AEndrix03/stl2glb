version: "3.8"

volumes:
  vcpkg_cache:
    driver: local
    driver_opts:
      type: none
      device: /home/vcpkg
      o: bind
  build_cache:
    driver: local

networks:
  stl2glb-network:
    driver: bridge

services:
  # Builder ottimizzato con multi-stage build
  builder:
    image: ubuntu:22.04
    container_name: stl2glb_builder
    volumes:
      - ./:/project
      - vcpkg_cache:/vcpkg_cache
      - build_cache:/build_cache
    working_dir: /project
    environment:
      # Ottimizzazioni per vcpkg
      VCPKG_MAX_CONCURRENCY: "8"
      VCPKG_BINARY_SOURCES: "clear;files,/vcpkg_cache,readwrite"
      # Ottimizzazioni per compilazione
      MAKEFLAGS: "-j8"
      CMAKE_BUILD_PARALLEL_LEVEL: "8"
    command: >
      bash -c "
      # Installa dipendenze minime
      apt-get update && apt-get install -y --no-install-recommends \
        build-essential cmake git curl ca-certificates ninja-build \
        pkg-config zip unzip tar && \
      
      # Setup vcpkg se non esiste
      if [ ! -d /vcpkg_cache/vcpkg ]; then
        git clone https://github.com/Microsoft/vcpkg.git /vcpkg_cache/vcpkg && \
        /vcpkg_cache/vcpkg/bootstrap-vcpkg.sh -disableMetrics;
      fi && \
      
      # Installa dipendenze con vcpkg (con cache)
      export VCPKG_ROOT=/vcpkg_cache/vcpkg && \
      export PATH=$VCPKG_ROOT:$PATH && \
      vcpkg install openssl nlohmann-json cpp-httplib draco --triplet x64-linux && \
      
      # Build ottimizzata
      cmake -B build -S . \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
        -GNinja && \
      cmake --build build --config Release --parallel 8 && \
      
      # Cleanup per ridurre dimensione
      apt-get clean && rm -rf /var/lib/apt/lists/*
      "
    networks:
      - stl2glb-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 1G
        reservations:
          cpus: '2'
          memory: 1G

  # App container ottimizzato e minimale
  app:
    # Usa immagine distroless per sicurezza e dimensioni ridotte
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:22.04 AS runtime
        
        # Installa solo runtime dependencies
        RUN apt-get update && apt-get install -y --no-install-recommends \
          libssl3 libcurl4 ca-certificates && \
          apt-get clean && rm -rf /var/lib/apt/lists/*
        
        # Crea user non-root
        RUN useradd -m -u 1000 -s /bin/bash appuser
        
        FROM runtime
        
        WORKDIR /app
        
        # Copia solo l'eseguibile
        COPY --from=builder /project/build/stl2glb_exec /app/
        
        # Cambia ownership
        RUN chown -R appuser:appuser /app
        
        USER appuser
        
        EXPOSE 8080
        
        # Usa exec form per segnali corretti
        ENTRYPOINT ["/app/stl2glb_exec"]

    container_name: stl2glb_app
    depends_on:
      builder:
        condition: service_completed_successfully

    # DNS ottimizzato con cache
    dns:
      - 8.8.8.8
      - 8.8.4.4

    ports:
      - "9002:8080"

    restart: unless-stopped

    env_file:
      - .env

    # Host fissi per evitare lookup DNS
    extra_hosts:
      - "minio:217.160.248.228"
      - "minio.aredegalli.it:217.160.248.228"

    # Health check ottimizzato
    healthcheck:
      test: ["CMD", "curl", "-f", "--connect-timeout", "1", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Configurazione risorse ottimizzata
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M

    # Logging ottimizzato
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    networks:
      - stl2glb-network

  # Health monitor sidecar (opzionale)
  health-monitor:
    image: alpine:3.18
    container_name: stl2glb_monitor
    command: >
      sh -c "
      apk add --no-cache curl && \
      while true; do
        if ! curl -sf http://app:8080/health > /dev/null; then
          echo 'Health check failed at' $(date);
        fi;
        sleep 30;
      done
      "
    depends_on:
      - app
    networks:
      - stl2glb-network
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M

# Configurazione globale per performance
x-common-variables: &common-variables
  TZ: UTC
  MALLOC_ARENA_MAX: 2  # Riduce frammentazione memoria